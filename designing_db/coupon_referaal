ğŸ¯ FEATURE TO DESIGN

User A refers User B
User B uses referral coupon on first order â†’ gets 10% off
Then User A gets 10% off on their next order
Constraints:

User A cannot refer himself

Coupon usable only once by User B


âœ… STEP 1 â€” FINAL Business Events (Corrected)

	We convert rules into events + validations.

	âœ”ï¸ Business Events

	User A generates / shares referral code

	User B applies referral code

	System validates referral

	User A â‰  User B

	Referral not already used

	User B places first order

	System applies 10% discount to User B

	System marks referral as consumed

	System grants User A a reward for next order

	ğŸ‘‰ Notice:

	â€œUsers cannot refer himselfâ€ â†’ validation

	â€œUsers apply coupon only onceâ€ â†’ validation

	ğŸ‘ Perfect.



âœ… FINAL Referral Statuses (Interview-ready)
	Referral lifecycle:

	created

	Referral code generated by User A

	No one has used it yet

	applied

	User B has applied the referral code

	But order is not completed yet

	used

	User B completed first order successfully

	Referral benefit is consumed

	expired (optional, advanced)

	Referral not used within validity period


### referrals table
id referall_by  referaal_to code status referred_at used_at cretaed_at updated_at


### orders
id user_id referral_id discount


##########################################


Nice featureâ€”classic referral flow, interview favorite ğŸ˜„
Iâ€™ll design this in a clean, scalable, interview-ready way, and explain why each table exists.

ğŸ¯ Core Entities

You already have:

users

orders

Weâ€™ll add three tables:

referrals

coupons

coupon_usages

1ï¸âƒ£ users (existing)
users
-----
id (PK)
email
name
created_at

2ï¸âƒ£ referrals

Tracks who referred whom

referrals
---------
id (PK)
referrer_id (FK â†’ users.id)   -- User A
referee_id  (FK â†’ users.id)   -- User B
code        (unique)          -- referral code shared
created_at

ğŸ”’ Constraints

referrer_id != referee_id â†’ prevents self-referral

UNIQUE(referee_id) â†’ User B can be referred only once

ğŸ‘‰ This table answers:

Who referred this user?

3ï¸âƒ£ coupons

Represents discount rules

coupons
-------
id (PK)
code (unique)
discount_type   -- percentage / flat
discount_value  -- 10
owner_id (FK â†’ users.id, nullable)
source          -- referral / marketing
usable_once     -- boolean
expires_at
created_at

Examples:

Coupon for User B â†’ owner_id = User B

Coupon for User A â†’ owner_id = User A

4ï¸âƒ£ coupon_usages

Tracks actual usage

coupon_usages
-------------
id (PK)
coupon_id (FK â†’ coupons.id)
user_id   (FK â†’ users.id)
order_id  (FK â†’ orders.id)
used_at

ğŸ”’ Constraints
UNIQUE (coupon_id, user_id)


ğŸ‘‰ Enforces:

Coupon usable only once per user

ğŸ§  How the Flow Works
ğŸ” Step 1: User A refers User B

Create row in referrals

Generate referral code

ğŸ›’ Step 2: User B places first order

Apply 10% coupon

Insert into coupon_usages

Mark coupon as consumed

ğŸ Step 3: Reward User A

Create new coupon for User A

Coupon is valid for next order only

ğŸš¨ Constraint Enforcement (DB + App)
Rule	Where
U| Rule                                     | Where                             |
| ---------------------------------------- | --------------------------------- |
| User canâ€™t refer himself                 | DB check + app validation         |
| User B coupon usable once                | `coupon_usages` unique constraint |
| User A reward only after Bâ€™s first order | business logic                    |
| One referral per referee                 | unique index on `referee_id`      |


âœ” Normalized
âœ” Scalable (supports future campaigns)
âœ” Auditable (you know who used what and when)
âœ” Easy to extend (cashback, tiers, expiry)