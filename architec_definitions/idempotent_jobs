What does idempotent background job mean?

A background job is idempotent if:

Running the same job multiple times produces the same final result as running it once.

In simple words:
ğŸ‘‰ Duplicate execution should NOT cause duplicate side effects.

Why this matters (very important)

Background jobs can run more than once because of:

Retries after failure

Worker crashes

Network timeouts

At-least-once delivery (Sidekiq, SQS, Kafka)

So the system must assume:

â€œThis job might execute again.â€

Non-idempotent job (âŒ bad)
def perform(user_id)
  user = User.find(user_id)
  user.balance += 100
  user.save!
end


If job runs twice:

User gets â‚¹200 instead of â‚¹100 ğŸ’¥

âŒ Not idempotent

Idempotent job (âœ… good)
Example 1: Use a unique operation key
def perform(user_id, transaction_id)
  return if Transaction.exists?(transaction_id: transaction_id)

  User.transaction do
    Transaction.create!(transaction_id: transaction_id, user_id: user_id, amount: 100)
    user = User.lock.find(user_id)
    user.balance += 100
    user.save!
  end
end


Even if job runs twice:

Second run sees transaction already exists

No duplicate effect

âœ… Idempotent

Common idempotency patterns
1ï¸âƒ£ Database uniqueness constraint (best)
add_index :payments, :reference_id, unique: true

Payment.create!(reference_id: ref_id) # second run raises error


DB is the source of truth.

2ï¸âƒ£ â€œSet stateâ€ instead of â€œincrementâ€

âŒ Bad:

user.login_count += 1


âœ… Good:

user.last_login_at = Time.current


Setting values is naturally idempotent.

3ï¸âƒ£ Check-before-act
return if order.paid?
order.mark_paid!

4ï¸âƒ£ Distributed lock / dedup (Redis)
Sidekiq.redis do |r|
  r.setnx("job:#{job_id}", true)
end


Prevents parallel execution.

Sidekiq-specific concepts (interview gold)

Sidekiq provides at-least-once execution

Jobs can and will retry

Hence jobs must be idempotent

ğŸ‘‰ Exactly why Sidekiq docs stress this.

Real-world examples
Email sending

âŒ Non-idempotent:

Send email blindly â†’ user gets 5 emails

âœ… Idempotent:

Store email_sent_at

Send only if nil

File upload to S3

Use deterministic object key

Same upload overwrites instead of creating duplicates

One-liner for interviews ğŸ¯

â€œAn idempotent background job guarantees that even if it runs multiple times due to retries or failures, the system state remains correct and side effects happen only once.â€