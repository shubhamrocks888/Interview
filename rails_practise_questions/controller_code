âŒ Whatâ€™s WRONG with this code
class OrdersController < ApplicationController
  def create
    order = Order.new(order_params)
    if order.save
      Inventory.decrease(order.product_id)
      Payment.charge(order)
      Notification.send(order)
    end
  end
end

1ï¸âƒ£ No transaction

If Inventory.decrease succeeds

Payment.charge fails

Order is saved but system is inconsistent âŒ

2ï¸âƒ£ Business logic in controller

Controller doing inventory, payment, notification

Hard to test

Not reusable

3ï¸âƒ£ External API inside DB flow

Payment is external

DB rollback wonâ€™t undo payment

4ï¸âƒ£ No error handling

If any step fails â†’ silent failure

No response handling

âœ… INTERVIEW-EXPECTED FIX (BEST PRACTICE)
ğŸ¯ Move logic to a Service Object
ğŸ¯ Use DB transaction
ğŸ¯ Keep controller thin
âœ… FIXED VERSION (Interview-Ready)
ğŸ“¦ app/services/orders/create_order.rb
class Orders::CreateOrder
  def initialize(order_params)
    @order_params = order_params
  end

  def call
    Order.transaction do
      order = Order.create!(@order_params)

      Inventory.decrease!(order.product_id)

      Payment.charge!(order)

      Notification.send(order)

      order
    end
  rescue => e
    Rails.logger.error(e.message)
    raise
  end
end

ğŸ® Controller (Clean & Thin)
class OrdersController < ApplicationController
  def create
    Orders::CreateOrder.new(order_params).call
    render json: { success: true }, status: :created
  rescue
    render json: { error: "Order failed" }, status: :unprocessable_entity
  end
end

âš ï¸ VERY IMPORTANT INTERVIEW POINT
âŒ This is STILL NOT PERFECT

Why?

Payment.charge!


ğŸ‘‰ External API calls should NOT be inside DB transaction

ğŸ¯ Interviewer expects you to say this!
âœ… EVEN BETTER (Senior-Level Answer)
Step 1ï¸âƒ£ Transaction for DB-only work
Step 2ï¸âƒ£ Trigger async job after commit
class Orders::CreateOrder
  def call
    order = nil

    Order.transaction do
      order = Order.create!(@order_params)
      Inventory.decrease!(order.product_id)
    end

    PaymentJob.perform_later(order.id)

    order
  end
end

ğŸ¯ Payment Job
class PaymentJob < ApplicationJob
  def perform(order_id)
    order = Order.find(order_id)
    Payment.charge!(order)
    Notification.send(order)
  end
end

ğŸ§  PERFECT INTERVIEW ANSWER (30 seconds)

â€œThis code mixes business logic into the controller and lacks transaction safety. Iâ€™d move the logic into a service object, wrap DB operations in a transaction, and trigger external calls like payments asynchronously after commit.â€