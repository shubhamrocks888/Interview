##### find out the bugs

class User < ApplicationRecord

  belongs_to :profile                
 
  validates :email, uniqueness: true, presence: true, format: :email
 
  before_save :set_default_role     
 
  after_create :send_welcome_email  
 
  def set_default_role

    self.role ||= "admin"          

  end
 
  def send_welcome_email

    WelcomeMailer.welcome(self).deliver_now 

  end
 
  def full_name

    first_name + " " + last_name 

  end

end


######  Solution

Nice ðŸ‘ â€” this is a classic Rails interview trap.
There are multiple hidden bugs + bad practices here. Iâ€™ll go line-by-line like an interviewer expects.

1ï¸âƒ£ belongs_to :profile âŒ (Potential Bug)
belongs_to :profile

âŒ Problem

From Rails 5+, belongs_to is required by default.

If:

a user can exist without a profile

or profile is created later

ðŸ‘‰ User.create(...) will fail validation

âœ… Fix (if optional)
belongs_to :profile, optional: true


ðŸŽ¯ Interview line:

â€œIn Rails 5+, belongs_to is required by default, so this can break user creation.â€

2ï¸âƒ£ validates :email, format: :email âŒ (Bug)
validates :email, uniqueness: true, presence: true, format: :email

âŒ Problem

Rails does NOT have a built-in :email format validator

This will raise:

ArgumentError: Unknown validator: 'EmailValidator'

âœ… Fix
validates :email,
  presence: true,
  uniqueness: true,
  format: { with: URI::MailTo::EMAIL_REGEXP }


ðŸŽ¯ Interview gold line:

â€œRails doesnâ€™t ship with a default email validator.â€

3ï¸âƒ£ before_save :set_default_role âŒ (Logical Bug)
before_save :set_default_role

âŒ Problem

This runs:

on create

AND every update

If someone updates user later:

user.update(role: nil)


ðŸ‘‰ It silently resets role to "admin" ðŸ˜±

âœ… Fix

Use before_create

before_create :set_default_role


ðŸŽ¯ Interview line:

â€œDefault values should be set only once, not on every save.â€

4ï¸âƒ£ Default role = "admin" âŒâŒ (Security Bug)
self.role ||= "admin"

âŒ Problem

Every new user becomes admin by default.

Thatâ€™s a security disaster.

âœ… Fix
self.role ||= "user"


ðŸŽ¯ Interview line:

â€œDefaulting users to admin is a serious security issue.â€

5ï¸âƒ£ after_create :send_welcome_email âŒ (Performance Bug)
after_create :send_welcome_email

âŒ Problems

Runs inside request lifecycle

If mail server is slow â†’ user signup is slow

If mail fails â†’ user creation may rollback (depending)

âœ… Fix (Best Practice)

Use background job

after_create_commit :send_welcome_email

def send_welcome_email
  WelcomeMailer.welcome(self).deliver_later
end


ðŸŽ¯ Interview line:

â€œEmails should always be async and after commit.â€

6ï¸âƒ£ deliver_now âŒ (Scalability Bug)
WelcomeMailer.welcome(self).deliver_now

âŒ Problem

Blocks request

Not scalable

âœ… Fix
deliver_later


(Uses ActiveJob + Sidekiq)

7ï¸âƒ£ full_name method âŒ (Nil Bug)
def full_name
  first_name + " " + last_name
end

âŒ Problem

If either is nil:

NoMethodError: undefined method `+` for nil:NilClass

âœ… Fix (safe)
def full_name
  [first_name, last_name].compact.join(" ")
end


ðŸŽ¯ Interview line:

â€œThis method breaks if first_name or last_name is nil.â€

8ï¸âƒ£ Missing DB-level uniqueness constraint âŒ
validates :email, uniqueness: true

âŒ Problem

Race condition:

Two parallel requests can create same email

âœ… Fix (DB index)
add_index :users, :email, unique: true


ðŸŽ¯ Interview line:

â€œUniqueness validation must always be backed by DB index.â€

âœ… Final â€œCorrectedâ€ Version (Interview-Ready)
class User < ApplicationRecord
  belongs_to :profile, optional: true

  validates :email,
            presence: true,
            uniqueness: true,
            format: { with: URI::MailTo::EMAIL_REGEXP }

  before_create :set_default_role
  after_create_commit :send_welcome_email

  def set_default_role
    self.role ||= "user"
  end

  def send_welcome_email
    WelcomeMailer.welcome(self).deliver_later
  end

  def full_name
    [first_name, last_name].compact.join(" ")
  end
end