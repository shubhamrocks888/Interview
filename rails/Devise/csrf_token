üîê CSRF Token in Rails
1Ô∏è‚É£ What is CSRF?

CSRF (Cross-Site Request Forgery) is an attack where a malicious website tricks a logged-in user into making unwanted requests to your web app.

Example:

User is logged in to bank.com

Visits malicious.com

Malicious page sends:

POST https://bank.com/transfer


Without protection, this could transfer money using the user‚Äôs session.

2Ô∏è‚É£ How Rails protects

Rails uses a CSRF token:

A random, per-session value generated for each user session

Embedded in HTML forms or sent via headers (for Ajax)

Rails verifies the token on each non-GET request (POST, PATCH, DELETE)

2.1 Session-Based Storage

CSRF token is stored in Rails session, which is itself stored in the browser (cookie)

On request:

session[:_csrf_token]


Forms embed this token:

<%= form_with model: @user do |f| %>
  <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
<% end %>


When the form is submitted, Rails compares the token in params/header with the session token.

2.2 How Devise interacts with CSRF

Devise uses session cookies for authentication

Any malicious POST from another site won‚Äôt have the correct CSRF token ‚Üí Rails rejects the request (HTTP 422)

Example: password reset form, sign in form, account update form ‚Üí all protected

3Ô∏è‚É£ CSRF Token Flow

1Ô∏è‚É£ User logs in ‚Üí session cookie created (via Warden/Devise)
2Ô∏è‚É£ Rails generates CSRF token ‚Üí stores in session
3Ô∏è‚É£ Rails embeds token in all forms / Ajax headers
4Ô∏è‚É£ Browser submits form ‚Üí token included in POST params or header
5Ô∏è‚É£ Rails compares submitted token with session token

‚úÖ Match ‚Üí request processed
‚ùå Mismatch ‚Üí Rails raises ActionController::InvalidAuthenticityToken

4Ô∏è‚É£ CSRF Token Details

Random per session ‚Üí changes on login/logout

Rotates automatically in Rails 5+ (per session or per form)

Works only with session-based authentication, not stateless APIs (like JWT)

5Ô∏è‚É£ Devise + CSRF Considerations
Feature	How CSRF is handled
Sign in	CSRF token required in POST form
Sign up	CSRF token required
Password reset	CSRF token validated on submission
Remember-me auto-login	Not affected, because GET requests don‚Äôt require CSRF
API / JSON	Must use skip_before_action :verify_authenticity_token or tokens via headers
6Ô∏è‚É£ Interview-Trap Points

CSRF protects against ‚Äúlogged-in user tricks‚Äù, not brute-force login attacks

GET requests are safe, CSRF applies only to state-changing requests

Devise forms are automatically protected if you use form_for / form_with

7Ô∏è‚É£ One-Line Interview Answer

‚ÄúCSRF tokens are per-session random tokens stored in Rails session and embedded in forms; Rails validates them on non-GET requests to prevent cross-site request forgery, and Devise uses them to protect all authentication and account-related forms.‚Äù