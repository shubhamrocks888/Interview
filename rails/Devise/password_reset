ğŸ” Devise Password Reset Flow (Recoverable Module)
1ï¸âƒ£ What module is responsible?
devise :recoverable


Handles forgot password / reset

Sends a secure token to the userâ€™s email

Allows resetting the password safely

2ï¸âƒ£ DB Columns for Password Reset

When you enable recoverable, Devise expects:

t.string   :reset_password_token
t.datetime :reset_password_sent_at


reset_password_token â†’ temporary token used for verification

reset_password_sent_at â†’ timestamp to expire the token

3ï¸âƒ£ Forgot Password Flow

1ï¸âƒ£ User clicks â€œForgot password?â€ in your app
2ï¸âƒ£ User enters email
3ï¸âƒ£ Devise generates a secure random token:

raw_token = Devise.friendly_token
user.reset_password_token = Devise.token_generator.digest(User, :reset_password_token, raw_token)
user.reset_password_sent_at = Time.current
user.save!


Token is hashed before saving in DB

Raw token is sent via email:

https://example.com/users/password/edit?reset_password_token=RAW_TOKEN

4ï¸âƒ£ Reset Password Token Security

Tokens are one-way hashed in DB (like passwords, though simpler than bcrypt)

Protects against token leaks in DB

Tokens expire: default 6 hours (config.reset_password_within)

5ï¸âƒ£ User Clicks Reset Link

User opens link with token:

GET /users/password/edit?reset_password_token=RAW_TOKEN


Devise controller:

User.with_reset_password_token(params[:reset_password_token])


Devise hashes the token and compares with DB value

If token is valid and not expired â†’ user can enter new password

6ï¸âƒ£ Reset Password Submission

User submits:

POST /users/password
params = {
  user: {
    reset_password_token: "...",
    password: "new_password",
    password_confirmation: "new_password"
  }
}


Devise:

Validates token

Checks token expiration

Updates encrypted_password with new hashed password

Clears reset token:

user.update(
  encrypted_password: new_hashed_password,
  reset_password_token: nil,
  reset_password_sent_at: nil
)


Optionally logs the user in immediately (configurable)

7ï¸âƒ£ Columns Updated During Password Reset
Column	When Updated
encrypted_password	Always (new password)
reset_password_token	Cleared after reset
reset_password_sent_at	Cleared after reset

Optional (if trackable):

Column	Updated
auth_salt	Changes because password changed â†’ invalidates old sessions
8ï¸âƒ£ Security Considerations

Token is one-time use â†’ prevents replay attacks

Token expiry â†’ prevents old tokens from being used

auth_salt change â†’ automatically logs out old sessions

Passwords stored as bcrypt hash â†’ never plain text

9ï¸âƒ£ Flow Diagram (Interview Friendly)
Forgot Password Request
          â†“
Generate raw token â†’ hash â†’ save reset_password_token & reset_password_sent_at
          â†“
Send raw token via email link
          â†“
User clicks link â†’ Devise hashes token â†’ compare with DB
          â†“
Token valid & not expired?
  â†“               â†“
Yes â†’ show reset form  No â†’ error / expired
          â†“
User submits new password
          â†“
Update encrypted_password, clear reset_password_token & reset_password_sent_at
          â†“
Optionally log in user, invalidate old sessions (auth_salt)

ğŸ”Ÿ One-Line Interview Answer (Perfect)

â€œDeviseâ€™s recoverable module allows password reset by generating a one-time, time-limited token stored as a hash in the DB (reset_password_token). When the user submits the reset form, Devise validates the token, updates encrypted_password, clears the token, and optionally logs in the user.â€