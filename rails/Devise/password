ğŸ” Devise Password Handling (From Zero)
1ï¸âƒ£ What DB fields does Devise create for password?

When you generate a Devise user model:

rails generate devise User

Core password-related fields
t.string :email,              null: false, default: ""
t.string :encrypted_password, null: false, default: ""


ğŸ“Œ Only ONE password field exists â†’ encrypted_password

âŒ There is NO password column
âŒ There is NO password_confirmation column

2ï¸âƒ£ Why no password column?
Interview answer

Passwords should never be stored in plain text. Devise stores only a one-way encrypted version using bcrypt.

Reality

password is a virtual attribute

Exists only in memory

Never persisted

3ï¸âƒ£ What about these fields?
password
password_confirmation


These are:

Virtual attributes

Created by Devise

Used only for validation

Cleared after save

ğŸ‘‰ They live in Ruby object, not DB.

4ï¸âƒ£ How does Devise store the password internally?
Step-by-step flow
1ï¸âƒ£ User signs up
User.create(
  email: "test@example.com",
  password: "secret123",
  password_confirmation: "secret123"
)

2ï¸âƒ£ Devise intercepts password

Internally (simplified):

def password=(new_password)
  self.encrypted_password = password_digest(new_password)
end

5ï¸âƒ£ Encryption: bcrypt (VERY IMPORTANT)

Devise uses bcrypt.

BCrypt::Password.create("secret123")


Result looks like:

$2a$12$u4Fj2gK9V6xNnP...random_hash

What this string contains:

Algorithm ($2a$)

Cost factor (12)

Salt

Hash

ğŸ“Œ Same password never generates same hash

6ï¸âƒ£ Where does bcrypt come from?

Gemfile:

gem 'bcrypt', '~> 3.1.7'


Devise depends on bcrypt, not its own encryption.

7ï¸âƒ£ What is â€œcostâ€ / â€œstretchesâ€?

From config/initializers/devise.rb:

config.stretches = Rails.env.test? ? 1 : 12

Meaning

Number of hashing rounds

Higher = slower = more secure

Protects against brute-force attacks

ğŸ“Œ Interview tip:

Increasing stretches improves security but impacts performance.

8ï¸âƒ£ What is pepper? (Advanced question â­)
config.pepper = 'some-secret-key'

What it does

Extra secret added to password before hashing

Stored outside DB

Even if DB is leaked, password harder to crack

Flow:

hash(password + pepper)

9ï¸âƒ£ How does login password verification work?

When user logs in:

User.find_by(email: params[:email])


Then:

BCrypt::Password.new(encrypted_password) == entered_password


âœ” If match â†’ login
âŒ If not â†’ failure

ğŸ“Œ Password is never decrypted

ğŸ” Signup vs Login Password Flow
Action	What happens
Signup	Password â†’ bcrypt â†’ encrypted_password
Login	Password â†’ bcrypt compare â†’ true/false
DB	Stores only encrypted_password
ğŸ” What about password validation?

Devise adds validations via :validatable

devise :validatable


Which enforces:

Email presence & format

Password presence

Minimum length (default 6)

Configurable in:

config.password_length = 6..128

1ï¸âƒ£0ï¸âƒ£ Password Reset Fields (recoverable)

If enabled:

devise :recoverable


DB fields:

t.string   :reset_password_token
t.datetime :reset_password_sent_at


ğŸ“Œ Password reset does NOT store password
âœ” Uses temporary token

1ï¸âƒ£1ï¸âƒ£ Common Interview Traps ğŸš¨
â“ Is encrypted_password reversible?

ğŸ‘‰ âŒ No (one-way hash)

â“ Can two users have same encrypted password?

ğŸ‘‰ âŒ No (salt makes hashes unique)

â“ Where is password stored?

ğŸ‘‰ âŒ Nowhere in plain text
ğŸ‘‰ âœ” Only encrypted_password

â“ Is bcrypt fast or slow?

ğŸ‘‰ Intentionally slow (security feature)

1ï¸âƒ£2ï¸âƒ£ Production-Level Notes (Senior Interview)

Increasing stretches increases CPU usage

Devise rehashes password if cost changes

Password comparison is timing-attack safe

Plain password lives only for one request

ğŸ§  One-Line Interview Summary

â€œDevise never stores plain passwords.
It uses bcrypt to hash passwords into encrypted_password, with salt, cost factor, and optional pepper.
Password and password_confirmation are virtual attributes used only for validation.â€









#########

Short Answer (Interview-ready)

âŒ encrypted_password is never decrypted.
âœ… The salt is already embedded inside the encrypted_password.
During login, bcrypt extracts the salt and cost from encrypted_password, hashes the incoming password using them, and compares the result.

So your understanding is conceptually correct, just the wording needs refinement.

What You Said vs Reality
You said:

â€œa salt is extracted from encrypted_password and that salt is added to incoming password and then we check both encrypted password are sameâ€

Correct version:

bcrypt extracts salt + cost from encrypted_password, hashes the incoming password using those parameters, and compares the hashes

ğŸ”‘ Important:
You donâ€™t manually add salt â€” bcrypt handles it internally.

Letâ€™s Break It Down Step-by-Step
1ï¸âƒ£ Stored value in DB (encrypted_password)

Example:

$2a$12$u4Fj2gK9V6xNnPqP9XJ9uOe4lN2m9H9g7fJmR8ZxQJq3kP0a


This single string contains:

Part  Meaning
$2a$  bcrypt algorithm
$12$  cost factor (stretches)
u4Fj2gK9V6xNnPqP9XJ9uO  salt
rest  hashed password

ğŸ‘‰ Salt is embedded, not stored separately.

2ï¸âƒ£ User enters password at login
entered_password = "secret123"

3ï¸âƒ£ bcrypt comparison (THIS IS THE KEY LINE)
BCrypt::Password.new(encrypted_password) == entered_password


What happens internally:

bcrypt reads encrypted_password

Extracts:

salt

cost factor

Hashes:

hash(entered_password + salt)


Compares result with stored hash

Returns true or false

ğŸš« At no point is encrypted_password decrypted.

Why This Is Secure

Salt prevents rainbow table attacks

Cost factor slows brute-force attempts

One-way hashing (no reverse possible)

Same password â†’ different hash every time

Common Interview Follow-Up Questions
â“ Is salt stored separately?

ğŸ‘‰ âŒ No, itâ€™s embedded in encrypted_password

â“ Can we extract original password from hash?

ğŸ‘‰ âŒ Impossible (one-way)

â“ Why not encrypt instead of hash?

ğŸ‘‰ Encryption is reversible â†’ insecure for passwords

Ultra-Short Interview Statement (Perfect Answer)

â€œDevise never decrypts passwords.
bcrypt stores salt and cost inside encrypted_password.
During login, bcrypt extracts those values, hashes the incoming password, and compares the result.â€


###

Better version:

Salt is a random value combined with the password during hashing (not encryption) to generate a unique hash.


##

A hash is a fixed-length, irreversible output produced by running input data through a hashing algorithm.

###
âœ… Short, correct answer (interview-ready)

The salt is extracted from encrypted_password by the bcrypt library itself when BCrypt::Password.new(encrypted_password) is called.

Not by Devise.