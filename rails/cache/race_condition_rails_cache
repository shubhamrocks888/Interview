Rails.cache.fetch( 
	"expensive_data", 
	expires_in: 10.minutes, 
	race_condition_ttl: 5.seconds 
	) 
	do 
		heavy_computation 
	end 
	
	Prevents cache stampede.



First: what problem are we solving?
	Cache stampede (a.k.a. thundering herd)

	Scenario:

	Cache key expires

	100 requests hit at the same time

	All 100 recompute heavy_computation

	DB/API melts ğŸ”¥


Without race_condition_ttl
Rails.cache.fetch("expensive_data", expires_in: 10.minutes) do
  heavy_computation
end


Timeline
T=0    cache expires
T=0.1  request #1 â†’ MISS â†’ recompute
T=0.1  request #2 â†’ MISS â†’ recompute
T=0.1  request #3 â†’ MISS â†’ recompute
...
T=0.1  request #100 â†’ MISS â†’ recompute


âŒ 100 expensive calls


With race_condition_ttl
Rails.cache.fetch(
  "expensive_data",
  expires_in: 10.minutes,
  race_condition_ttl: 5.seconds
) do
  heavy_computation
end


What race_condition_ttl REALLY does

It allows serving a slightly stale value for a short window while one request recomputes the cache.

Timeline (this is the key ğŸ”‘)
T=0     cache expires
T=0â€“5s  race_condition window


Request behavior
ğŸ”¹ Request #1 (winner)

	Sees expired key
	Allowed to recompute
	Runs heavy_computation
	Writes new value

ğŸ”¹ Request #2â€“#100 (losers)

	See expired key
	BUT race window is active
	Rails serves stale cached value
	Do NOT recompute


Visual model
	Expired
	â”‚
	â”œâ”€â”€ One request recomputes
	â”‚
	â””â”€â”€ Others temporarily use old value


Why this works

Old value is better than nothing
Prevents DB / API storm
Small staleness (5s) is acceptable

Important clarifications ğŸš¨
	â— It does NOT:

	Lock Redis
	Block threads
	Make others wait

	â— It DOES:

	Serve stale data briefly
	Allow only one recomputation


Real-world example
	Without protection

	Dashboard loads â†’ DB spike
	App becomes slow

With protection

One request recomputes
Others get slightly old data
App stays healthy

When should you use it?

âœ… Expensive queries
âœ… Read-heavy endpoints
âœ… Dashboards
âœ… Aggregations


âŒ Payments
âŒ User balances
âŒ Critical real-time data

How to choose value?

Rule of thumb:

race_condition_ttl â‰ˆ 2 Ã— computation time


If query takes ~2 seconds â†’ use ~5 seconds.