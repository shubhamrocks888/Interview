ğŸ”¹ What is race_condition_ttl?
Short definition

race_condition_ttl prevents a cache stampede when a cached value expires.

ğŸ§  The Problem (Cache Stampede)

Without race_condition_ttl:

Cache expires at 10:00:00
100 requests hit at 10:00:01
âŒ All 100 recompute `heavy_computation`
âŒ DB / CPU spike

ğŸ”§ What race_condition_ttl: 5.seconds does
Rails.cache.fetch(
  "expensive_data",
  expires_in: 10.minutes,
  race_condition_ttl: 5.seconds
) do
  heavy_computation
end


Rails behavior:

Cache expires

First request starts recomputing

Old value is kept alive for 5 seconds

Other requests:

Get stale value

Do NOT recompute

New value replaces old one

ğŸ”„ Timeline (Very Clear)
T = 10:00:00 cache expires
T = 10:00:01 request #1 â†’ recompute
T = 10:00:02 request #2 â†’ gets old value
T = 10:00:03 request #3 â†’ gets old value
T = 10:00:04 request #4 â†’ gets old value
T = 10:00:05 new value written

âš ï¸ Important Details
ğŸ”¸ Only ONE process recomputes

Rails uses a soft lock internally.

ğŸ”¸ Others get stale data

For a short, controlled time.

ğŸ”¸ Staleness is acceptable

Better than overload.

âŒ What race_condition_ttl is NOT

âŒ Not cache expiration

âŒ Not retry logic

âŒ Not background job

âŒ Not distributed locking

ğŸ”¥ Interview One-Liner (Perfect)

â€œrace_condition_ttl allows serving stale cache briefly to prevent cache stampedes when a value expires.â€

ğŸ§ª Example Without It (Bad)
Rails.cache.fetch("x", expires_in: 1.minute) do
  expensive_call
end


High traffic â†’ thundering herd problem.

ğŸ§ª Example With It (Good)
Rails.cache.fetch(
  "x",
  expires_in: 1.minute,
  race_condition_ttl: 10.seconds
) do
  expensive_call
end


Smooth traffic.

ğŸ¯ When should you use it?

Use race_condition_ttl when:

Heavy DB queries

External API calls

CPU-intensive computation

High traffic endpoints

ğŸ§  One Mental Model

expires_in â†’ hard TTL
race_condition_ttl â†’ grace period

âš ï¸ Gotcha (Interview bonus)

race_condition_ttl only works with cache stores that support expiration metadata
(e.g. Memcached, Redis).
Itâ€™s ignored by some simple stores.

âœ… Final Summary

Prevents cache stampede

Serves stale data briefly

Protects DB & CPU

Essential in high traffic Rails apps